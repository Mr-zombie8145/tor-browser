From 4277b435fae6e73bb6e6ecf9f94a03a5480fd42e Mon Sep 17 00:00:00 2001
From: Mike Hommey <mh+mozilla@glandium.org>
Date: Wed, 8 Jan 2020 14:30:21 +0000
Subject: [PATCH] Bug 1606739 - Initialize the .dynamic section first.
 r=froydnj

Differential Revision: https://phabricator.services.mozilla.com/D59078

--HG--
extra : moz-landing-system : lando

diff --git a/build/unix/elfhack/elf.cpp b/build/unix/elfhack/elf.cpp
index ba1f7de18e03..78de2312c02b 100644
--- a/build/unix/elfhack/elf.cpp
+++ b/build/unix/elfhack/elf.cpp
@@ -179,6 +179,14 @@ Elf::Elf(std::ifstream& file) {
   // Fill sections list
   sections = new ElfSection*[ehdr->e_shnum];
   for (int i = 0; i < ehdr->e_shnum; i++) sections[i] = nullptr;
+  for (int i = 1; i < ehdr->e_shnum; i++) {
+    // The .dynamic section is going to have references to other sections,
+    // so it's better to start with that one and recursively initialize those
+    // other sections first, to avoid possible infinite recursion (bug 1606739).
+    if (tmp_shdr[i]->sh_type == SHT_DYNAMIC) {
+      getSection(i);
+    }
+  }
   for (int i = 1; i < ehdr->e_shnum; i++) {
     if (sections[i] != nullptr) continue;
     getSection(i);
-- 
2.25.1

